name: Express CI with AI

on:
  pull_request:
    branches: [main]
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Run ESLint
      run: npm run lint || true

    - name: Run Tests
      run: |
        npm test > test-report.log 2>&1 || true
        echo "===== TEST REPORT LOG ====="
        cat test-report.log

    - name: Explain Test Failures with GPT
      if: failure()
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "Test failed, sending logs to GPT..."

        if [ -f test-report.log ]; then
          CONTENT=$(tail -n 50 test-report.log | sed 's/"/\\"/g')
        else
          CONTENT="No test-report.log file found."
        fi

        RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
          -H "Authorization: Bearer $OPENAI_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{
            \"model\": \"gpt-3.5-turbo\",
            \"messages\": [
              {\"role\": \"system\", \"content\": \"You are an experienced Node.js developer. Explain this test failure.\"},
              {\"role\": \"user\", \"content\": \"$CONTENT\"}
            ]
          }")

        echo "===== GPT EXPLANATION START ====="
        echo "$RESPONSE"
        echo "===== GPT EXPLANATION END ====="
